<!DOCTYPE html>
<html lang="{{ details.details.detectedLanguage | default('en') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ details.details.lessonTitle }}</title>
    <style>
        body { /* ... same styles as provided in previous full response ... */ }
        /* ... (all other styles from your refined PDF template) ... */

        /* Styling for list items that are blocks themselves */
        .list-item-block-container {
            margin-left: -1.2em; /* Offset the default list item padding */
            padding-left: 0;
        }
        .list-item-block-container .content-block {
             margin-bottom: 0.5em; /* Reduce margin for blocks inside lists */
        }

         /* Nested lists indentation */
        .bullet-list-block ul ul, .bullet-list-block ul ol,
        .numbered-list-block ol ul, .numbered-list-block ol ol {
            margin-top: 0.25em;
            margin-bottom: 0.5em;
            padding-left: 1.25em; /* Further indentation for nested lists */
        }
        .bullet-list-block .icon-prefix { margin-right: 0.5em; }

    </style>
</head>
<body>
    <div class="container">
        {% if details.details.lessonTitle %}
            <h1 class="lesson-title">{{ details.details.lessonTitle }}</h1>
        {% endif %}

        {# --- Jinja2 Macro for rendering block (can be called recursively) --- #}
        {% macro render_block_content(block_item) %}
            {% if block_item.type == 'headline' %}
                <div class="headline-block headline-block-h{{ block_item.level }}"
                     style="{% if block_item.backgroundColor %}background-color: {{ block_item.backgroundColor }}; padding: 0.5rem; border-radius: 0.25rem;{% endif %} {% if block_item.textColor %}color: {{ block_item.textColor }};{% endif %}">
                    {% if block_item.iconName %}<span class="icon-placeholder">[{{ block_item.iconName | upper }}]</span>{% endif %}
                    {{ block_item.text }}
                </div>
            {% elif block_item.type == 'paragraph' %}
                <p class="paragraph-block">{{ block_item.text }}</p>
            {% elif block_item.type == 'bullet_list' %}
                <div class="bullet-list-block">
                    <ul>
                        {{ render_list_items(block_item.items, 'bullet', block_item.iconName) }}
                    </ul>
                </div>
            {% elif block_item.type == 'numbered_list' %}
                <div class="numbered-list-block">
                    <ol>
                        {{ render_list_items(block_item.items, 'numbered', None) }}
                    </ol>
                </div>
            {% elif block_item.type == 'alert' %}
                <div class="alert-block alert-{{ block_item.alertType | default('info') }}"
                     style="{% if block_item.backgroundColor %}background-color: {{ block_item.backgroundColor }};{% endif %}
                            {% if block_item.borderColor %}border-color: {{ block_item.borderColor }};{% endif %}
                            {% if block_item.textColor %}color: {{ block_item.textColor }};{% endif %}">
                    <span class="icon-placeholder" style="{% if block_item.iconColor %}color: {{ block_item.iconColor }};{% endif %}">
                        {% if block_item.iconName %}[{{ block_item.iconName | upper }}]
                        {% elif block_item.alertType == 'success' %}&#10004;
                        {% elif block_item.alertType == 'warning' %}&#9888;
                        {% elif block_item.alertType == 'danger' %}&#10060;
                        {% else %}&#8505;{% endif %}
                    </span>
                    <div class="alert-content">
                        {% if block_item.title %}
                            <div class="alert-title" style="{% if block_item.textColor %}color: {{ block_item.textColor }};{% endif %}">{{ block_item.title }}</div>
                        {% endif %}
                        <div class="alert-text" style="{% if block_item.textColor %}color: {{ block_item.textColor }};{% endif %}">{{ block_item.text }}</div>
                    </div>
                </div>
            {% elif block_item.type == 'section_break' %}
                 {% if block_item.style == 'none' %}
                    <div class="section-break-block section-break-none"></div>
                {% else %}
                    <hr class="section-break-block section-break-{{ block_item.style | default('solid') }}" />
                {% endif %}
            {% else %}
                <p style="color: red;">Unsupported block type: {{ block_item.type }}</p>
            {% endif %}
        {% endmacro %}

        {# --- Jinja2 Macro for rendering list items recursively --- #}
        {% macro render_list_items(items, list_type, list_icon_name) %}
            {% for item in items %}
                <li>
                    {% if item is string %}
                        {% if list_type == 'bullet' and list_icon_name %}
                            {# For simplicity, not trying to render complex icons for string items here #}
                        {% endif %}
                        {{ item }}
                    {% else %} {# Item is an object (a content block) #}
                       <div class="list-item-block-container">
                           {{ render_block_content(item) }}
                       </div>
                    {% endif %}
                </li>
            {% endfor %}
        {% endmacro %}
        {# --- End Macros --- #}

        {% for block in details.details.contentBlocks %}
            <div class="content-block">
                {{ render_block_content(block) }}
            </div>
        {% endfor %}
    </div>
</body>
</html>
