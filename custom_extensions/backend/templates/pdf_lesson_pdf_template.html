<!DOCTYPE html>
<html lang="{{ lesson_data.detectedLanguage if lesson_data and lesson_data.detectedLanguage else 'ru' }}">
<head>
    <meta charset="UTF-8">
    <title>{% set segments = (lesson_data.lessonTitle if lesson_data and lesson_data.lessonTitle else 'PDF Lesson').split('**') %}{% for segment in segments %}{% if loop.index0 is odd %}<span style="font-weight: var(--font-weight-medium); color: var(--color-text-black);">{{ segment }}</span>{% else %}{{ segment }}{% endif %}{% endfor %}</title>
    <style>
        /* stylelint-disable */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        html {
          box-sizing: border-box;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        *, *:before, *:after {
          box-sizing: inherit;
        }

        :root {
            --font-primary: 'Inter', Arial, sans-serif;
            --color-primary-accent: #FF1414;
            --color-primary-accent-dark: #CC1010;
            --color-primary-accent-light-bg: #fafafa;
            --color-text-black: #000000;
            --color-text-darkest: #18181B;
            --color-text-default: #4B4B4B; 
            --color-text-muted: #4B4B4B;  
            --color-border-extralight: #F3F4F6;
            --color-border-light: #E5E7EB; 
            --color-background-page: #FFFFFF;

            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            --font-size-paragraph-small: 8pt; /* UPDATED */
            --font-size-list-item: 8pt; 
            --font-size-base: 10pt;
            --line-height-base: 1.5; 

            --font-size-main-title: 19pt; 
            --font-size-h1-content: 13pt;  
            --font-size-other-section-header: 14pt; 

            --font-size-h3-box: 11pt;
            --font-size-h4-box: 10pt;
            --font-size-p-box: 8.5pt;

            --font-size-mini-title: 8pt;
            --font-size-mini-title-text: 7pt;
            
            --list-number-circle-size: 24px;
            --list-number-font-size: 11pt;

            --space-xxs: 2px; --space-xs: 4px; --space-sm: 8px; --space-md: 12px;
            --space-lg: 18px; --space-xl: 24px; --space-2xl: 32px; --space-3xl: 48px;
            --content-max-width-constrained: 75%;
            
            --color-alert-text: #4B4B4B;
            --letter-spacing-increased: 0.02em; 
        }

        @page { margin-top: 10mm; margin-bottom: 12mm; margin-left: 10mm; margin-right: 10mm; size: A4; }
        body {
            font-family: var(--font-primary); margin: 0; padding: 0;
            background-color: var(--color-background-page); color: var(--color-text-default);
            font-size: var(--font-size-base); font-weight: var(--font-weight-normal);
            line-height: var(--line-height-base); widows: 3; orphans: 3;
            letter-spacing: var(--letter-spacing-increased);
        }
        .pdf-container { width: 100%; padding: 0; }
        .lesson-title-section { margin-bottom: 8px; }
        .lesson-title-text {
            font-size: var(--font-size-main-title); font-weight: var(--font-weight-medium);
            color: var(--color-text-darkest); margin: 0 0 var(--space-sm) 0; 
            line-height: 1.5; letter-spacing: var(--letter-spacing-increased); text-transform: uppercase;
        }
        .icon-svg { display: inline-block; vertical-align: middle; width: 1em; height: 1em; flex-shrink: 0; }
        .icon-svg.icon-new-bullet { fill: currentColor; stroke: none; }
        .icon-svg.icon-lesson-goal rect { fill: #FF1414 !important; }
        .icon-svg.icon-lesson-goal path { fill: white !important; }
        .icon-svg.icon-last-section-star rect { fill: #FF1414 !important; } 
        .icon-svg.icon-last-section-star path { fill: white !important; }


        .content-block-wrapper { margin-bottom: var(--space-sm); } 
        .content-block-wrapper:last-child { margin-bottom: 0; }

        .headline-block { display: flex; align-items: center; line-height: 1.5; max-width: 100%; text-transform: uppercase; letter-spacing: var(--letter-spacing-increased); }
        .headline-block .icon-svg:not(.icon-last-section-star):not(.icon-lesson-goal) { 
            margin-right: var(--space-sm); width: 0.8em; height: 0.8em; 
            flex-shrink: 0; color: var(--color-primary-accent);
        }
         .headline-block .icon-svg.icon-lesson-goal, .headline-block .icon-svg.icon-last-section-star {
            width: 16px; height: 16px; margin-right: var(--space-sm);
            /* vertical-align: text-top; or adjust with small top margin if needed */
             position: relative; /* For fine-tuning */
             top: 0.1em; /* Adjust this value */
         }

        .headline-block span { flex-grow: 1; }
        .headline-block.h1 { font-size: var(--font-size-h1-content); font-weight: var(--font-weight-medium); color: var(--color-text-darkest); margin-top: var(--space-2xl); margin-bottom: 8px; }
        .headline-block.h2 { font-family: var(--font-primary); font-size: var(--font-size-other-section-header); font-weight: var(--font-weight-medium); color: var(--color-text-darkest); line-height: 1.5; letter-spacing: var(--letter-spacing-increased); margin-top: 16px; margin-bottom: 12px; }
        .headline-block.h2 .icon-svg:not(.icon-last-section-star) { display: none; } 
        .headline-block.h3 { font-size: var(--font-size-h3-box); font-weight: var(--font-weight-medium); color: var(--color-text-black); margin-top: 10px; margin-bottom: 6px; }
        .headline-block.h4 { font-size: var(--font-size-h4-box); font-weight: var(--font-weight-medium); color: var(--color-text-black); margin-top: 8px; margin-bottom: 4px; }
        .mini-section-box .headline-block.h4 { margin-top: 0; font-size: var(--font-size-h4-box); font-weight: var(--font-weight-medium); color: var(--color-text-black); align-items: center; }
        
        .paragraph-block { font-size: var(--font-size-paragraph-small); line-height: 1.5; letter-spacing: var(--letter-spacing-increased); font-weight: var(--font-weight-normal); margin-bottom: var(--space-sm); color: var(--color-text-default); }
        .paragraph-block.recommendation { font-size: 8pt; color: var(--color-text-muted); margin-top: var(--space-sm); margin-bottom:0; font-weight: var(--font-weight-medium); padding-left: 13px; position: relative; line-height: 1.5; letter-spacing: var(--letter-spacing-increased); }
        .paragraph-block.recommendation::before { content: ""; position: absolute; left: 0; top: 0.1em; height: calc(100% - 0.2em); width: 3px; background-color: var(--color-primary-accent); }

        .list-block-wrapper ul, .list-block-wrapper ol { padding-left: 0; list-style-type: none; margin-top: var(--space-xs); margin-bottom: var(--space-md); max-width: 100%; }
        .list-block-wrapper li { 
            margin-bottom: var(--space-xs); 
            font-size: var(--font-size-list-item); 
            font-weight: var(--font-weight-normal); 
            line-height: 1.5; 
            color: var(--color-text-default); 
            display: flex; 
            align-items: flex-start;
            letter-spacing: var(--letter-spacing-increased);
        }
        
        .content-wrapper > .content-block-wrapper.type-bullet_list ul > li > .list-marker,
        .mini-section-box ul > li > .list-marker {
            margin-right: var(--space-xs); 
            flex-shrink: 0;
            padding-top: 0.2em; /* Nudge icon container down a bit */
        }
        
        .content-wrapper > .content-block-wrapper.type-bullet_list ul > li > .list-marker .icon-svg,
        .mini-section-box ul > li > .list-marker .icon-svg {
            width: 0.7em;  
            height: 0.7em; 
            color: var(--color-primary-accent); 
            fill: currentColor; 
            stroke: none; 
            display: block; 
        }
        .list-item-content-wrapper ul > li > .list-marker .icon-svg { 
            width: 0.6em; 
            height: 0.6em;
            color: var(--color-text-muted); 
        }
        .list-item-text-or-block { flex-grow: 1; }
        
        .mini-section-box > .content-block-wrapper.type-bullet_list,
        .mini-section-box > .content-block-wrapper.type-numbered_list {
             padding-left: calc(16px + var(--space-sm)); /* Indent list block within mini-section */
        }


        .content-wrapper > .content-block-wrapper.type-numbered_list > .list-block-wrapper > ol { list-style: none; padding-left: 0; margin-top: var(--space-lg); counter-reset: numbered-box-li; }
        
        /* --- MODIFICATION 1: Replaced old list item style with Flexbox layout --- */
        .content-wrapper > .content-block-wrapper.type-numbered_list > .list-block-wrapper > ol > li {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            border: 1px solid var(--color-primary-accent);
            background-color: var(--color-primary-accent-light-bg);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            border-radius: 5px;
            line-height: 1.5;
            letter-spacing: var(--letter-spacing-increased);
            font-size: var(--font-size-list-item);
        }

        /* --- MODIFICATION 2: Removed absolute positioning from number circle --- */
        .list-number-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: var(--list-number-circle-size);
            height: var(--list-number-circle-size);
            border-radius: 50%;
            background-color: var(--color-primary-accent);
            color: white;
            font-weight: var(--font-weight-semibold);
            font-size: var(--list-number-font-size);
            line-height: var(--list-number-circle-size);
            text-align: center;
            flex-shrink: 0;
        }

        .list-number-circle::before { counter-increment: numbered-box-li; content: counter(numbered-box-li); }
        .list-content-column { width: 100%; }
        .content-wrapper > .content-block-wrapper.type-numbered_list > .list-block-wrapper > ol > li::before { display: none; content: ""; }
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li > .list-marker { display: none; }
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column .list-item-text-or-block > .content-block-wrapper.type-bullet_list { margin-bottom: 0; }
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column .list-block-wrapper.type-bullet_list > ul { margin: 0; padding: 0; list-style: none; }
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column .list-block-wrapper.type-bullet_list > ul > li { padding: 0; margin: 0 0 var(--space-xs) 0; display: flex; align-items: flex-start; } 
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column .list-block-wrapper.type-bullet_list > ul > li:last-child { margin-bottom: 0; }
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column .list-block-wrapper.type-bullet_list > ul > li > .list-marker { display: flex; }

        /* --- MODIFICATION 3: Added rule to remove top margin from headline in list item --- */
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column > .content-block-wrapper:first-child > .headline-block {
            margin-top: 0;
        }
        
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column .list-block-wrapper.type-bullet_list .headline-block { margin-top: -3px !important; margin-bottom: var(--space-xs) !important; font-size: var(--font-size-mini-title); font-weight: var(--font-weight-medium); color: var(--color-text-black); line-height: 1.5; text-transform: uppercase; letter-spacing: var(--letter-spacing-increased); }
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column .list-block-wrapper.type-bullet_list .headline-block .icon-svg { display: none; }
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column .list-block-wrapper.type-bullet_list .paragraph-block { font-size: var(--font-size-mini-title-text); font-weight: var(--font-weight-normal); color: var(--color-text-muted); max-width: 100%; line-height: 1.5; letter-spacing: var(--letter-spacing-increased); }
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column .list-block-wrapper.type-bullet_list .paragraph-block.recommendation { font-size: 8pt; color: var(--color-text-muted); margin-top: var(--space-sm); margin-bottom: 0; font-weight: var(--font-weight-medium); padding-left: 13px; position: relative; letter-spacing: var(--letter-spacing-increased); line-height: 1.5;}
        .content-wrapper > .content-block-wrapper.type-numbered_list ol > li .list-content-column .list-block-wrapper.type-bullet_list .paragraph-block.recommendation::before { content: ""; position: absolute; left: 0; top: 0.1em; height: calc(100% - 0.2em); width: 3px; background-color: var(--color-primary-accent); }

        .alert-block { display: flex; padding: var(--space-md); border-left-width: 4px; border-radius: 3px; margin-bottom: var(--space-md); font-size: var(--font-size-paragraph-small); page-break-inside: avoid; color: var(--color-alert-text) !important; line-height: 1.5; letter-spacing: var(--letter-spacing-increased); }
        .alert-block .icon-container { margin-right: var(--space-sm); flex-shrink: 0; padding-top: 0.1em; }
        .alert-block .icon-container .icon-svg { width: 1.2em; height: 1.2em; }
        .alert-block .text-container { flex-grow: 1; }
        .alert-block .alert-title { font-weight: var(--font-weight-semibold); margin-bottom: var(--space-xxs); } 
        .alert-block .alert-text { }
        .alert-block.alert-info { background-color: #E0F2FE; border-color: #3B82F6; }
        .alert-block.alert-info .icon-container { color: #3B82F6; }
        .alert-block.alert-success { background-color: #D1FAE5; border-color: #10B981; }
        .alert-block.alert-success .icon-container { color: #10B981; }
        .alert-block.alert-warning { background-color: #FEF3C7; border-color: #F59E0B; }
        .alert-block.alert-warning .icon-container { color: #F59E0B; }
        .alert-block.alert-danger { background-color: #FEE2E2; border-color: #EF4444; }
        .alert-block.alert-danger .icon-container { color: #EF4444; }


        .mini-section-box-wrapper { margin-top: var(--space-xl); margin-bottom: var(--space-xl); page-break-inside: avoid; }
        .mini-section-box { background-color: #FEF2F2; border-left: 4px solid #F87171; border-radius: 5px; padding: var(--space-md) var(--space-xl); }
        .mini-section-box > .content-block-wrapper:first-child { margin-top: 0 !important; }
        .mini-section-box > .content-block-wrapper:first-child > .headline-block { margin-top: 0 !important; }
        .mini-section-box > .content-block-wrapper:last-child { margin-bottom: 0 !important; }
        .mini-section-box > .content-block-wrapper:last-child > .list-block-wrapper { margin-bottom: 0 !important; }
        .mini-section-box .content-block-wrapper, .mini-section-box .paragraph-block { max-width: 100%; }
        .mini-section-box .list-block-wrapper { max-width: 100%; }
        .mini-section-box .list-block-wrapper li { font-size: var(--font-size-list-item); }


        .section-break-block.solid, .section-break-block.dashed { border: none; border-top: 0.5pt solid var(--color-border-light); margin: var(--space-xl) 0; } 
        .section-break-block.none { height: var(--space-lg); border:none; }
        .content-section-divider { border: none; border-top: 0.5pt solid var(--color-border-light); margin: var(--space-md) 0 var(--space-xs) 0; max-width: 100%; }

        .content-wrapper > .content-block-wrapper.type-paragraph { max-width: var(--content-max-width-constrained); }
        .content-wrapper > .content-block-wrapper.type-alert { max-width: var(--content-max-width-constrained); }
        .list-block-wrapper .content-block-wrapper.type-paragraph { max-width: 100%; }

        .headline-block, .alert-block, .mini-section-box-wrapper, li, .paragraph-block { page-break-inside: avoid; }
        .headline-block.h2 { page-break-before: auto; page-break-after: avoid; }
        hr.content-section-divider { page-break-before: auto; page-break-after: avoid;}
        /* stylelint-enable */
    } /* ensure all open selectors closed */
    /* stylelint-enable */
    </style>
</head>
<body>
    <svg width="0" height="0" style="position:absolute;display:none;" aria-hidden="true">
        <defs>
            <symbol id="icon-lesson-goal" width="16" height="16" viewBox="-1 -1 18 18" xmlns="http://www.w3.org/2000/svg">
                <rect width="16" height="16" rx="8" fill="#FF1414"/> 
                <path fill-rule="evenodd" clip-rule="evenodd" d="M7.66681 3.66672C5.08942 3.66672 3 5.75606 3 8.33336C3 10.9107 5.08942 13 7.66681 13C10.2442 13 12.3336 10.9107 12.3336 8.33336C12.3336 7.70679 12.2098 7.10913 11.9858 6.56324L11.9441 6.6049C11.8353 6.71373 11.6922 6.78166 11.5391 6.79694L11.0311 6.84761C11.232 7.30193 11.3438 7.80451 11.3438 8.33325C11.3438 10.364 9.69753 12.0101 7.66681 12.0101C5.63599 12.0101 3.9898 10.3639 3.9898 8.33325C3.9898 6.30261 5.6361 4.65637 7.66681 4.65637C8.19535 4.65637 8.69784 4.76817 9.15206 4.96889L9.20263 4.46137C9.21791 4.30813 9.28617 4.1649 9.39489 4.05607L9.43656 4.01441C8.89076 3.79049 8.2933 3.66672 7.66681 3.66672ZM9.36818 6.16003L9.53428 4.49445C9.5422 4.41772 9.5765 4.34627 9.63058 4.29175L10.8249 3.09753C10.9172 3.00574 11.0538 2.97551 11.1757 3.02069C11.2977 3.06576 11.3832 3.17766 11.393 3.30715L11.4873 4.51237L12.6933 4.60713C12.822 4.61735 12.9342 4.70188 12.9793 4.82401C13.0245 4.94602 12.9941 5.08321 12.9027 5.175L11.7085 6.36922C11.6544 6.42385 11.5827 6.4576 11.506 6.4653L9.84 6.63139L7.90272 8.56893C7.83786 8.63389 7.75234 8.66665 7.66681 8.66665C7.58129 8.66665 7.49576 8.63389 7.4309 8.56893C7.30119 8.43878 7.30119 8.22772 7.4309 8.09746L9.36818 6.16003ZM7.66681 6.99997C7.78609 6.99997 7.90173 7.01569 8.01177 7.04515L7.19522 7.86178C6.93524 8.12175 6.93534 8.54398 7.19489 8.80428C7.3201 8.92981 7.48961 8.99994 7.66681 8.99994C7.84391 8.99994 8.0132 8.92981 8.13841 8.80461L8.95485 7.98798C8.98431 8.09812 9.00014 8.21387 9.00014 8.33336C9.00014 9.06975 8.40323 9.66664 7.66681 9.66664C6.9304 9.66664 6.33348 9.06975 6.33348 8.33336C6.33348 7.59697 6.9304 6.99997 7.66681 6.99997ZM7.66681 5.32296C8.1782 5.32296 8.6598 5.45069 9.08149 5.6756L9.04829 6.00845L8.52865 6.52806C8.26768 6.40319 7.97538 6.33328 7.6667 6.33328C6.56214 6.33328 5.66666 7.22872 5.66666 8.33325C5.66666 9.43777 6.56214 10.3332 7.6667 10.3332C8.77127 10.3332 9.66675 9.43777 9.66675 8.33325C9.66675 8.02447 9.59672 7.73207 9.47174 7.47089L9.99148 6.95105L10.3241 6.91786C10.5494 7.33975 10.6771 7.82144 10.6771 8.33303C10.6771 9.99553 9.32927 11.3433 7.6667 11.3433C6.00414 11.3433 4.6563 9.99553 4.6563 8.33303C4.6563 6.67053 6.00425 5.32296 7.66681 5.32296Z" fill="white"/>
            </symbol>
            <symbol id="icon-last-section-star" width="16" height="16" viewBox="-1 -1 18 18" xmlns="http://www.w3.org/2000/svg">
                <rect width="16" height="16" rx="8" fill="#FF1414"/>
                <path d="M7.68389 3.24065C7.78339 2.91978 8.21661 2.91978 8.31611 3.24065L9.26859 6.31234C9.31309 6.45584 9.4407 6.553 9.5847 6.553H12.667C12.989 6.553 13.1228 6.98473 12.8624 7.18304L10.3687 9.08144C10.2522 9.17013 10.2035 9.32733 10.248 9.47083L11.2005 12.5425C11.3 12.8634 10.9495 13.1302 10.689 12.9319L8.19536 11.0335C8.07887 10.9448 7.92113 10.9448 7.80464 11.0335L5.31101 12.9319C5.05052 13.1302 4.70004 12.8634 4.79954 12.5425L5.75202 9.47083C5.79651 9.32733 5.74777 9.17013 5.63127 9.08144L3.13765 7.18304C2.87716 6.98473 3.01103 6.553 3.33301 6.553H6.41531C6.5593 6.553 6.68692 6.45584 6.73141 6.31234L7.68389 3.24065Z" fill="white"/>
            </symbol>
            <symbol id="icon-new-bullet" viewBox="0 0 3 4">
                <path d="M3 2L8.69979e-08 3.73205L2.38419e-07 0.267944L3 2Z" fill="currentColor"/>
            </symbol>
            <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></symbol>
            <symbol id="icon-check" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"/> <path d="M5 12l5 5l10 -10" /> </symbol>
            <symbol id="icon-alertTriangle" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 9v4" /><path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" /><path d="M12 16h.01" /></symbol>
            <symbol id="icon-xCircle" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M10 10l4 4m0 -4l-4 4" /></symbol>
        </defs>
    </svg>

    <div class="pdf-container">
        {% set lesson_data = details.details %}
        {% set parent_project_name = details.parentProjectName %}
        {% set lesson_number = details.lessonNumber %}
        {% set locale = details.locale %}
        
        
        {% set first_block_is_title_duplicate = false %}
        {% if lesson_data is mapping and lesson_data.lessonTitle and lesson_data.contentBlocks and lesson_data.contentBlocks|length > 0 %}
            {% set first_block = lesson_data.contentBlocks[0] %}
            {% if first_block is mapping %}
                {% set first_block_text = first_block.get('text') %}
                {% if first_block_text is not none %}
                    {% if (first_block_text|string)|trim|lower == (lesson_data.lessonTitle|string)|trim|lower %}
                        {% set first_block_is_title_duplicate = true %}
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}

        {% if lesson_data is mapping and lesson_data.lessonTitle is defined %}
            {% if details.parentProjectName and details.lessonNumber %}
    <div style="border-left: 3px solid #FF1414; padding-left: 10px; margin-bottom: 8px;">
        <h2 style="text-transform: uppercase; font-size: 1.125rem; font-weight: 500; color: black; margin: 0;">
            <span style="color: #FF1414;">{{ locale.courseLabel }}:</span> {{ details.parentProjectName }}
        </h2>
    </div>
    <h1 class="lesson-title-text" style="font-size: 1.875rem; line-height: 2.25rem; margin-bottom: 24px;">
        <span style="color: #FF1414;">{{ locale.lessonLabel }} №{{ details.lessonNumber }}:</span> {{ lesson_data.lessonTitle }}
    </h1>
{% else %}
    <div class="lesson-title-section">
            <h1 class="lesson-title-text">
                {% set text_content = lesson_data.lessonTitle %}
                {% set segments = text_content.split('**') %}{% for segment in segments %}{% if loop.index0 is odd %}<span style="font-weight: var(--font-weight-medium); color: var(--color-text-black);">{{ segment }}</span>{% else %}{{ segment }}{% endif %}{% endfor %}
            </h1>
            </div>
{% endif %}
        {% endif %}

        {% set last_main_header_idx_list = [-1] %} 
        {% set found_last_header_flag_list = [false] %} 
        {% if lesson_data.contentBlocks %}
            {% for idx in range(lesson_data.contentBlocks | length - 1, -1, -1) %}
                {% if not found_last_header_flag_list[0] %}
                    {% set blk = lesson_data.contentBlocks[idx] %}
                    {% if blk is mapping and blk.type == 'headline' %}
                        {% if last_main_header_idx_list.pop() %}{% endif %}
                        {% set _ = last_main_header_idx_list.append(idx) %}
                        {% if found_last_header_flag_list.pop() %}{% endif %}
                        {% set _ = found_last_header_flag_list.append(true) %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
        {% set final_last_main_header_idx = last_main_header_idx_list[0] %}


        {% macro render_icon_svg_macro(icon_name_str, default_icon_for_type=None, css_class="", depth=0, is_last_section_header_for_star_icon_flag=false) %}
            {% set final_icon_name = icon_name_str %}

            {% if is_last_section_header_for_star_icon_flag %}
                {% set final_icon_name = 'last-section-star' %}
            {% elif default_icon_for_type == 'ul' or default_icon_for_type == 'ul-nested' %}
                {% if icon_name_str == 'none' %}{% set final_icon_name = 'none' %}
                {% else %}{% set final_icon_name = 'new-bullet' %}{% endif %}
            {% elif not icon_name_str %}
                {% if default_icon_for_type == 'h4-important' %}{% set final_icon_name = 'lesson-goal' %}
                {% elif default_icon_for_type == 'alert-info' %}{% set final_icon_name = 'info' %} 
                {% elif default_icon_for_type == 'alert-success' %}{% set final_icon_name = 'check' %} 
                {% elif default_icon_for_type == 'alert-warning' %}{% set final_icon_name = 'alertTriangle' %} 
                {% elif default_icon_for_type == 'alert-danger' %}{% set final_icon_name = 'xCircle' %} 
                {% endif %}
            {% elif (icon_name_str == 'target' or icon_name_str == 'award') and default_icon_for_type == 'h4-important' %}
                 {% set final_icon_name = 'lesson-goal' %}
            {% elif icon_name_str %}
                 {% set final_icon_name = icon_name_str %}
            {% endif %}

            {% if final_icon_name and final_icon_name != 'none' %}
                <svg class="icon-svg {{ css_class }} icon-{{final_icon_name}}"><use xlink:href="#icon-{{ final_icon_name }}" /></svg>
            {% endif %}
        {% endmacro %}

        {% macro render_list_items_recursive_macro(items_list, list_type_str, list_icon_name_str, depth, is_in_box_context_for_list) %}
            {% if items_list is iterable and items_list is not string and items_list|length > 0 %}
                {% for item_content in items_list %}
                    <li>
                        {% if list_type_str == 'numbered_list' %}
                            <span class="list-number-circle"></span>
                            <div class="list-content-column">
                                {% if item_content is mapping %}
                                    {{ render_single_block_recursive_macro(item_content, depth + 1, true, false) }}
                                {% elif item_content is string %}
                                    {# Auto-bold plain strings in numbered lists #}
                                    {% if '**' in item_content %}
                                        {% set _processed_str = item_content %}
                                    {% else %}
                                        {% set _processed_str = '**' ~ item_content ~ '**' %}
                                    {% endif %}
                                    <span>{% set segments = _processed_str.split('**') %}{% for segment in segments %}{% if loop.index0 is odd %}<span style="font-weight: var(--font-weight-medium); color: var(--color-text-black);">{{ segment }}</span>{% else %}{{ segment }}{% endif %}{% endfor %}</span>
                                {% elif item_content is iterable %}
                                    {{ render_single_block_recursive_macro(item_content, depth + 1, true, false) }}
                                {% else %}
                                    <span class="error-message">Numbered list item content is not string or dict.</span>
                                {% endif %}
                            </div>
                        {% else %} {# bullet_list logic #}
                            <div class="list-marker">
                                {{ render_icon_svg_macro(list_icon_name_str, 'ul' if depth == 0 else 'ul-nested', 'bullet-icon', depth, false) }}
                            </div>
                            <div class="list-item-text-or-block">
                            {% if item_content is string %}
                                <span>{% set segments = item_content.split('**') %}{% for segment in segments %}{% if loop.index0 is odd %}<span style="font-weight: var(--font-weight-medium); color: var(--color-text-black);">{{ segment }}</span>{% else %}{{ segment }}{% endif %}{% endfor %}</span>
                            {% elif item_content is mapping %}
                                {{ render_single_block_recursive_macro(item_content, depth + 1, is_in_box_context_for_list, false) }}
                            {% else %}
                                <span class="error-message">Item is not string or dict: {{ item_content }}</span>
                            {% endif %}
                            </div>
                        {% endif %}
                    </li>
                {% endfor %}
            {% elif items_list is none or (items_list is iterable and items_list|length == 0) %}
            {% else %}
                <li class="error-message">Items list for "{{list_type_str}}" is not iterable. Type: {{ items_list|type }}</li>
            {% endif %}
        {% endmacro %}

        {% macro render_single_block_recursive_macro(block_data, depth=0, is_in_box_context=false, is_last_main_header_for_star_flag=false) %}
            {% if block_data is mapping %}
                {% set block_type = block_data.get('type') %}
                {% set level = block_data.level | default(3) %}
                {% set is_important = block_data.get('isImportant') %}
                {% set text_content = block_data.text | default('') %}
                {% set alert_title_content = block_data.title | default('') %}


                <div class="content-block-wrapper type-{{block_type}}">
                    {% if block_type == 'headline' %}
                        <div class="headline-block h{{ level }}"
                             style="{% if block_data.backgroundColor %}background-color: {{ block_data.backgroundColor }};{% endif %} {% if block_data.textColor %}color: {{ block_data.textColor }}; fill: {{block_data.textColor}};{% endif %}">
                            {% if is_last_main_header_for_star_flag %}
                                {{ render_icon_svg_macro(None, None, 'icon-last-section-star', depth, true) }}
                            {% elif level == 4 and is_important %}
                                 {{ render_icon_svg_macro(block_data.iconName, 'h4-important', 'icon-lesson-goal' ) }}
                            {% endif %}
                            <span>{% set segments = text_content.split('**') %}{% for segment in segments %}{% if loop.index0 is odd %}<span style="font-weight: var(--font-weight-medium); color: var(--color-text-black);">{{ segment }}</span>{% else %}{{ segment }}{% endif %}{% endfor %}</span>
                        </div>
                    {% elif block_type == 'paragraph' %}
                        <p class="paragraph-block {{ 'recommendation' if block_data.isRecommendation else '' }}">{% set segments = text_content.split('**') %}{% for segment in segments %}{% if loop.index0 is odd %}<span style="font-weight: var(--font-weight-medium); color: var(--color-text-black);">{{ segment }}</span>{% else %}{{ segment }}{% endif %}{% endfor %}</p>
                    {% elif block_type == 'bullet_list' or block_type == 'numbered_list' %}
                        <div class="list-block-wrapper {{block_type}} depth-{{depth}}">
                            {% if block_type == 'bullet_list' %}
                                <ul>{{ render_list_items_recursive_macro(block_data.get('items'), block_type, block_data.iconName, depth, is_in_box_context) }}</ul>
                            {% else %} {# numbered_list #}
                                <ol>{{ render_list_items_recursive_macro(block_data.get('items'), block_type, None, depth, is_in_box_context) }}</ol>
                            {% endif %}
                        </div>
                    {% elif block_type == 'alert' %}
                       <div class="alert-block alert-{{ block_data.alertType | default('info') }}"
                             style="{% if block_data.backgroundColor %}background-color: {{ block_data.backgroundColor }};{% endif %}{% if block_data.borderColor %}border-color: {{ block_data.borderColor }};{% endif %}{% if block_data.textColor %}color: {{ block_data.textColor }};{% endif %}">
                            <div class="icon-container" style="{% if block_data.iconColor %}color: {{ block_data.iconColor }}; fill: {{ block_data.iconColor }};{% endif %}">
                                {{ render_icon_svg_macro(block_data.iconName, 'alert-' + (block_data.alertType|default('info')) ) }}
                            </div>
                            <div class="text-container">
                                {% if block_data.title %}<div class="alert-title">{% set segments = alert_title_content.split('**') %}{% for segment in segments %}{% if loop.index0 is odd %}<span style="font-weight: var(--font-weight-medium); color: var(--color-text-black);">{{ segment }}</span>{% else %}{{ segment }}{% endif %}{% endfor %}</div>{% endif %}
                                <div class="alert-text">{% set segments = text_content.split('**') %}{% for segment in segments %}{% if loop.index0 is odd %}<span style="font-weight: var(--font-weight-medium); color: var(--color-text-black);">{{ segment }}</span>{% else %}{{ segment }}{% endif %}{% endfor %}</div>
                            </div>
                        </div>
                    {% elif block_type == 'section_break' %}
                        {% if block_data.style == 'solid' or block_data.style == 'dashed' %}
                            <hr class="section-break-block {{ block_data.style }}">
                        {% elif block_data.style == 'none' %}
                             <div class="section-break-block none"></div>
                        {% endif %}
                    {% else %}
                        <p class="error-message">Unsupported block type: {{ block_type }}</p>
                    {% endif %}
                </div>
            {% else %}
                <p class="error-message">Block data is not a dictionary/mapping: {{ block_data }}</p>
            {% endif %}
        {% endmacro %}

        <div class="content-wrapper">
        {% if lesson_data is mapping and lesson_data.contentBlocks is iterable and lesson_data.contentBlocks is not string %}
            {% set next_block_in_box_content = [false] %}
            {% for loop_index in range(lesson_data.contentBlocks | length) %}
                {% set current_block_item = lesson_data.contentBlocks[loop_index] %}
                {% set next_block_item = lesson_data.contentBlocks[loop_index+1] if (loop_index+1) < (lesson_data.contentBlocks | length) else none %}
                {% set is_last_block_overall = loop_index == (lesson_data.contentBlocks | length) - 1 %}
                
                {% set is_this_block_last_main_header_for_star_flag = (current_block_item.type == 'headline' and loop_index == final_last_main_header_idx) %}

                {% if loop_index == 0 and first_block_is_title_duplicate %}
                {% elif next_block_in_box_content[0] %}
                    {% set _ = next_block_in_box_content.pop() %}{% set _ = next_block_in_box_content.append(false) %}
                {% else %}
                    {% set is_important_headline_check = current_block_item is mapping and current_block_item.get('type') == 'headline' and current_block_item.get('isImportant') %}
                    {% set is_relevant_content_following_for_box_check = next_block_item is mapping and next_block_item.get('type') in ['bullet_list', 'numbered_list', 'paragraph', 'alert'] %}
                    
                    {% if is_important_headline_check %} 
                        <div class="mini-section-box-wrapper"> <div class="mini-section-box">
                            {{ render_single_block_recursive_macro(current_block_item, 0, true, is_this_block_last_main_header_for_star_flag) }}
                            {% if is_relevant_content_following_for_box_check %}
                                {{ render_single_block_recursive_macro(next_block_item, 0, true, false) }}
                                {% set _ = next_block_in_box_content.pop() %}{% set _ = next_block_in_box_content.append(true) %}
                            {% endif %}
                        </div> </div>
                    {% else %} 
                        {{ render_single_block_recursive_macro(current_block_item, 0, false, is_this_block_last_main_header_for_star_flag) }}
                    {% endif %}
                {% endif %}

                {% set render_this_divider = false %}
                {% if not is_last_block_overall and current_block_item.type != 'section_break' %}
                    {% set current_block_type = current_block_item.get('type') %}
                    {% set next_block_type = next_block_item.get('type') if next_block_item else none %}
                    {% set next_block_level = next_block_item.get('level') if next_block_item and next_block_type == 'headline' else 99 %}
                    
                    {% set current_is_mini_section_box_end_heuristic = false %}
                    {% if current_block_type in ['bullet_list', 'numbered_list', 'paragraph', 'alert'] and loop_index > 0 %}
                        {% set prev_prev_block = lesson_data.contentBlocks[loop_index-1] %}
                        {% if prev_prev_block is mapping and prev_prev_block.type == 'headline' and prev_prev_block.isImportant == true %}
                            {% set current_is_mini_section_box_end_heuristic = true %}
                        {% endif %}
                    {% endif %}
                    
                    {% if next_block_type == 'headline' %}
                        {% if next_block_level <= 2 %}
                            {% if not (current_block_type == 'headline' and current_block_item.level == 2 and not current_block_item.isImportant) and not current_is_mini_section_box_end_heuristic %}
                                {% set render_this_divider = true %}
                            {% endif %}
                        {% elif next_block_level > 2 %}
                            {% if current_block_type != 'numbered_list' and not current_is_mini_section_box_end_heuristic %}
                                {% set render_this_divider = true %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endif %}

                {% if render_this_divider %}
                    <hr class="content-section-divider">
                {% endif %}

            {% endfor %}
        {% elif lesson_data and lesson_data.contentBlocks is not none %}
             <p class="error-message">contentBlocks is not iterable. Type: {{ lesson_data.contentBlocks|type }}</p>
        {% else %}
             <p class="warning-message">No content blocks found.</p>
        {% endif %}
        </div>
    </div>
</body>
</html>
